<?xml version="1.0" encoding="UTF-8"?>

<!--
 Eresus CMS

 Файл сборки проекта

 $Id$
 -->
<project name="eresus-cms" default="build" basedir="./">

	<!-- Основные файлы проекта -->
	<fileset dir="main" id="files.main">
		<include name="**" />
		<exclude name="**/.svn" />
		<exclude name="**/*.src" />
	</fileset>

		<!-- Основные файлы проекта. Только PHP -->
		<fileset dir="main" id="files.main.php">
			<include name="**/*.php" />
		</fileset>

	<!-- Модульные тесты -->
	<fileset dir="tests/phpunit" id="files.tests.phpunit">
		<include name="**/*Test.php" />
	</fileset>

	<!-- 3rd party: EditArea -->
	<fileset dir="3rdparty/edit_area" id="files.3rd.editarea">
		<include name="**" />
		<exclude name=".svn" />
	</fileset>

	<!-- 3rd party: Doctrine -->
	<fileset dir="3rdparty/doctrine/lib" id="files.3rd.doctrine">
		<include name="**" />
		<exclude name=".svn" />
	</fileset>

	<!-- 3rd party: Dwoo -->
	<fileset dir="3rdparty/dwoo" id="files.3rd.dwoo">
		<include name="**" />
		<exclude name=".svn" />
	</fileset>

	<!-- Tools files -->
	<fileset dir="." id="tools_files">
		<include name="tools/**" />
		<exclude name=".svn" />
	</fileset>

	<!-- 3rd party: jQuery -->
	<fileset dir="3rdparty/jquery" id="files.3rd.jquery">
		<include name="**" />
		<exclude name=".svn" />
	</fileset>

	<!-- 3rd party: elFinder -->
	<fileset dir="3rdparty/elfinder" id="files.3rd.elfinder">
		<include name="connectors/php/**" />
		<include name="css/**" />
		<include name="images/**" />
		<include name="js/**" />
		<exclude name="js/i18n/*" />
		<exclude name="js/jquery*" />
		<exclude name=".svn" />
		<exclude name=".gitignore" />
	</fileset>

	<!-- 3rd party: Tiny MCE -->
	<fileset dir="3rdparty/tiny_mce" id="files.3rd.tiny_mce">
		<include name="**" />
		<exclude name=".svn" />
	</fileset>


	<!-- SDK files -->
	<fileset dir="." id="SDK_files">
		<include name="SDK/**" />
		<exclude name=".svn" />
	</fileset>


	<property file="build.properties" />
	<php function="date" returnProperty="builddate">
	  <param value="Y-m-d"/>
	</php>

	<!--
	=====================================================================
		Подготовка к сборке
	=====================================================================
  -->

	<target name="prepare" description="Prepare for build">

		<delete dir="${build.dir}" includeemptydirs="true" />
		<mkdir dir="${build.dir}" />

		<mkdir dir="${logs.dir}" />

		<!--
			PHPUnit
		-->
		<if>
			<istrue value="${phpunit}" />
			<then>
			
				<mkdir dir="${phpunit.coverage.temp}" />

				<exec
					command="phpunit --log-junit ${logs.dir}/phpunit.xml --coverage-clover ${logs.dir}/phpunit.coverage.xml --coverage-html ${phpunit.coverage.html} ${project.basedir}/tests/phpunit/AllTests.php"
					checkreturn="true"
					logoutput="true"
				/> 

			</then>
		</if>
		
		<!--
			PHP_CodeSniffer
		-->
		<if>
			<istrue value="${phpcs}" />
			<then>

				<if>
					<equals arg1="${phpcs.format}" arg2="checkstyle" />
					<then>
						<property name="phpcs.file.extension" value="xml" />
					</then>
					<else>
						<property name="phpcs.file.extension" value="${phpcs.format}" />
					</else>
				</if>

				<phpcodesniffer
					standard="Eresus"
					haltonerror="false"
				>
					<formatter
						type="${phpcs.format}"
						outfile="${logs.dir}/phpcs.${phpcs.file.extension}"
					/>
					<fileset refid="files.main.php" />
				</phpcodesniffer>
			</then>
		</if>

	</target>

	<!--
	=====================================================================
		Создание документации
	=====================================================================
  -->
  <target name="docs" description="Generates API documentation">

		<delete dir="${docs.dir}" includeemptydirs="true" failonerror="true" />

		<phpdoc
			title="Eresus CMS API"
			destdir="${docs.dir}"
			sourcecode="no"
			parseprivate="false"
			output="${docs.converter}">
			<fileset dir="main">
				<include name="core/**/*.php" />
				<include name="3rd-ext/**/*.php" />
			</fileset>
			<projdocfileset dir=".">
				<include name="README" />
				<include name="INSTALL" />
				<include name="CHANGELOG" />
			</projdocfileset>
		</phpdoc>

  </target>

	<!--
	=====================================================================
		Сборка проекта
	=====================================================================
	-->
	<target name="build" depends="prepare" description="Build basic set of modules">

		<!-- Копирование основных файлов -->
		<copy todir="${build.dir}">
			<fileset refid="files.main" />
			<filterchain>
			    <expandproperties />
		  </filterchain>
		</copy>
		
		<!-- Doctrine -->
		<echo msg="Copying Doctrine..." level="info" />
		<copy todir="${build.dir}/core">
			<fileset refid="files.3rd.doctrine" />
			<filterchain>
				<expandproperties />
			</filterchain>
		</copy>

		<!-- Dwoo -->
		<copy todir="${build.dir}/core/Dwoo">
			<fileset refid="files.3rd.dwoo" />
		</copy>

		<!-- jQuery -->
		<copy todir="${build.dir}/core/jquery">
			<fileset refid="files.3rd.jquery" />
		</copy>

		<!-- elFinder -->
		<!-- exec command="make all COMPRESSOR='java -jar ../../yuicompressor-2.4.2.jar - -charset utf8 -o'"
			dir="3rdparty/elfinder/src" / -->
		<copy todir="${build.dir}/ext-3rd/elfinder">
			<fileset refid="files.3rd.elfinder" />
		</copy>
		<!-- exec command="make distclean" dir="3rdparty/elfinder/src" / -->
		<patch 
			patchfile="${project.basedir}/3rdparty/patches/elfinder/elFinder.class.php.patch" 
			dir="${build.dir}" 
			strip="0" 
		/>
		<patch 
			patchfile="${project.basedir}/3rdparty/patches/elfinder/elfinder.full.js.patch" 
			dir="${build.dir}" 
			strip="0" 
		/>
		<patch 
			patchfile="${project.basedir}/3rdparty/patches/elfinder/elfinder.css.patch" 
			dir="${build.dir}" 
			strip="0" 
		/>

		<!-- Tiny MCE -->
		<copy todir="${build.dir}/ext-3rd/tinymce">
			<fileset refid="files.3rd.tiny_mce" />
		</copy>

		<!-- EditArea -->
		<copy todir="${build.dir}/ext-3rd/editarea">
			<fileset refid="files.3rd.editarea" />
		</copy>

		<mkdir dir="${build.dir}/distrib" />
		<copy todir="${build.dir}/distrib">
			<fileset refid="tools_files" />
			<filterchain>
			    <expandproperties />
		  </filterchain>
		</copy>

  </target>

	<!--
		Build all
	-->
	<target name="all" depends="build" description="Build all modules">

		<mkdir dir="${build.dir}/distrib" />
		<copy todir="${build.dir}/distrib">
			<fileset refid="SDK_files" />
			<filterchain>
			    <expandproperties />
		  </filterchain>
		</copy>

	</target>

</project>
